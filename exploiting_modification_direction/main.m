img = imread('stego.bmp');

gray_img = rgb2gray(img);

secret_msg = 'Hello, world!';

n = 3; % °²?n = 3
msg_2n1 = custom_base_conversion(secret_msg, 2 * n + 1);


seed = 42;
rng(seed);
[height, width] = size(gray_img);
L = length(msg_2n1);


groups = zeros(L, n);
for i = 1 : L
    groups(i, :) = randperm(height * width, n);
end


embedded_img = gray_img;
for i = 1 : L
    group_pixels = embedded_img(groups(i, :));

    f = compute_f(group_pixels, n);
    
    d = msg_2n1(i);
    s = mod(d - f, 2 * n + 1);
    

    if s > 0
        if s <= n
            group_pixels(s) = group_pixels(s) + 1;
        else
            group_pixels(2 * n + 1 - s) = group_pixels(2 * n + 1 - s) - 1;
        end
    end
    

    embedded_img(groups(i, :)) = group_pixels;
end


imwrite(embedded_img, 'embedded_image.bmp');
imshow(embedded_img);title('embedded_imgage.bmp');
% ¦Û©w?¨ç?
function msg_2n1 = custom_base_conversion(msg, base)
    msg_2n1 = [];
    for i = 1 : length(msg)
        msg_2n1 = [msg_2n1, dec2base(msg(i), base)];
    end
end

function f = compute_f(group_pixels, n)
    [~, idx] = sort(group_pixels);
    f = find(idx == 1) - 1;
end